<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="admin/_admin.html">
<main layout:fragment="_main">
    <script>
        // search condition
        const userSearch = new duice.ObjectProxy({
            key: 'id',
            value: null,
            type: null,
            status: null,
            _page: 0,
            _size: 20,
            _count: 0
        });
        const roleSearch = new duice.ObjectProxy({
            key: 'id',
            value: null,
            _page: 0,
            _size: 20,
            _count: 0
        });
        const authoritySearch = new duice.ObjectProxy({
            key: 'id',
            value: null,
            _page: 0,
            _size: 20,
            _count: 0
        });

        // data
        const users = new duice.ArrayProxy([]);
        const roles = new duice.ArrayProxy([]);
        const authorities = new duice.ArrayProxy([]);

        /**
         * getUsers
         */
        function getUsers(page) {
            if(page) {
                userSearch._page = page;
            }
            let url = new URL("[[@{/admin/user/get-users}]]", document.location.origin);
            if (userSearch.key && userSearch.value) {
                url.searchParams.append(userSearch.key, userSearch.value);
            }
            if(userSearch.type) {
                url.searchParams.append('type', userSearch.type);
            }
            if(userSearch.status) {
                url.searchParams.append('status', userSearch.status);
            }
            url.searchParams.append('_page', userSearch._page);
            url.searchParams.append('_size', userSearch._size);
            _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ArrayProxy.clear(users);
                    duice.ArrayProxy.assign(users, data.content);
                    userSearch._count = data.totalElements;
                });
        }

        /**
         * resetUsers
         */
        function resetUsers() {
            duice.ObjectProxy.reset(userSearch);
            getUsers();
        }

        /**
         * getUser
         * @param id
         */
        function getUser(id) {
            userDetail.open(id).then(()=>{
                getUsers();
            });
        }

        /**
         * createUser
         */
        function createUser() {
            userDetail.open().then(()=>{
                getUsers();
            });
        }

        /**
         * getRoles
         */
        function getRoles() {
            let url = new URL("[[@{/admin/user/get-roles}]]", document.location.origin);
            if (roleSearch.key && roleSearch.value) {
                url.searchParams.append(roleSearch.key, roleSearch.value);
            }
            url.searchParams.append('_page', roleSearch._page);
            url.searchParams.append('_size', roleSearch._size);
            _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ArrayProxy.clear(roles);
                    duice.ArrayProxy.assign(roles, data.content);
                    console.log(data.totalElements);
                    roleSearch._count = data.totalElements;
                });
        }

        /**
         * getAuthorties
         */
        function getAuthorities() {
            let url = new URL("[[@{/admin/user/get-authorities}]]", document.location.origin);
            if (authoritySearch.key && authoritySearch.value) {
                url.searchParams.append(authoritySearch.key, authoritySearch.value);
            }
            url.searchParams.append('_page', authoritySearch._page);
            url.searchParams.append('_size', authoritySearch._size);
            _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ArrayProxy.clear(authorities);
                    duice.ArrayProxy.assign(authorities, data.content);
                    console.log(data.totalElements);
                    authoritySearch._count = data.totalElements;
                });
        }

        // DOMContentLoaded event
        document.addEventListener('DOMContentLoaded',()=> {
            let tabFolder = duice.tabFolder(
                duice.tabItem(document.getElementById('userTabButton'), document.getElementById('userTabContent'), () => {
                    getUsers();
                }),
                duice.tabItem(document.getElementById('roleTabButton'), document.getElementById('roleTabContent'), () => {
                    getRoles();
                }),
                duice.tabItem(document.getElementById('authorityTabButton'), document.getElementById('authorityTabContent'), () => {
                    getAuthorities();
                })
            );
            tabFolder.setActive(0);
        });

    </script>
    <h1>
        <img class="icon" th:src="@{/static/image/icon-user.png}"/>
        <span data-th-text="#{web.title.user}"></span>
    </h1>
    <div class="border-bottom-1">
        <button id="userTabButton" class="tab">
            <img class="icon" th:src="@{/static/image/icon-user.png}"/>
            <span data-th-text="#{core.user}"></span>
        </button>
        <button id="roleTabButton" class="tab">
            <img class="icon" th:src="@{/static/image/icon-role.png}"/>
            <span data-th-text="#{core.role}"></span>
        </button>
        <button id="authorityTabButton" class="tab">
            <img class="icon" th:src="@{/static/image/icon-authority.png}"/>
            <span data-th-text="#{core.authority}"></span>
        </button>
    </div>

    <!-- userTabContent -->
    <div id="userTabContent">
        <div class="container gap-1px margin-1px">
            <form onsubmit="return false;" class="col-8 col-s-12 container gap-1px">
                <select data-duice-object="userSearch" data-duice-property="key" class="col-1 col-s-4">
                    <option value="id" th:text="#{core.user.id}"></option>
                    <option value="name" th:text="#{core.user.name}"></option>
                    <option value="email" th:text="#{core.user.email}"></option>
                    <option value="mobile" th:text="#{core.user.mobile}"></option>
                </select>
                <input type="text" data-duice-object="userSearch" data-duice-property="value"
                       th:placeholder="#{web.text.keyword}" class="col-2 col-s-8"/>
                <select data-duice-object="userSearch" data-duice-property="type" class="col-1 col-s-12">
                    <option value data-th-text="'- '+#{core.user.type}+' -'"></option>
                    <option th:each="userType:${userTypes}" th:value="${userType}" th:text="${userType}"></option>
                </select>
                <select data-duice-object="userSearch" data-duice-property="status" class="col-1 col-s-12">
                    <option value data-th-text="'- '+#{core.user.status}+' -'"></option>
                    <option th:each="userStatus:${userStatuses}" th:value="${userStatus}"
                            th:text="${userStatus}"></option>
                </select>
                <button onclick="getUsers();" class="col-1 col-s-12">
                    <img class="icon" th:src="@{/static/image/icon-search.png}"/>
                    <span data-th-text="#{web.text.search}">Search</span>
                </button>
                <button onclick="resetUsers();" class="col-1 col-s-12">
                    <img class="icon" th:src="@{/static/image/icon-reset.png}"/>
                    <span data-th-text="#{web.text.reset}">Reset</span>
                </button>
            </form>
            <div class="col-4 col-s-12 justify-right">
                <button onclick="createUser();">
                    <img class="icon" th:src="@{/static/image/icon-create.png}"/>
                    <span data-th-text="#{web.text.create}"></span>
                </button>
            </div>
        </div>
        <div class="overflow-x-scroll border-1">
            <table class="border-0">
                <colgroup>
                    <col style="width:80px;"/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    <col style="width:70px;"/>
                </colgroup>
                <thead>
                <tr>
                    <th data-th-text="#{web.text.no}" class="ta-center"></th>
                    <th data-th-text="#{core.user.id}"></th>
                    <th data-th-text="#{core.user.name}"></th>
                    <th data-th-text="#{core.user.type}"></th>
                    <th data-th-text="#{core.user.status}"></th>
                    <th data-th-text="#{core.user.email}"></th>
                    <th data-th-text="#{core.user.mobile}"></th>
                    <th data-th-text="#{core.user.roles}"></th>
                    <th class="ta-center">-</th>
                </tr>
                </thead>
                <tbody>
                <tr data-duice-array="users" data-duice-loop="user,status">
                    <td data-duice-object="status" data-duice-property="count"></td>
                    <td>
                        <img data-duice-object="user" data-duice-property="photo"
                             th:src="@{/static/image/icon-null.png}" class="icon"/>
                        <span data-duice-object="user" data-duice-property="id" class="fw-bold"></span>
                    </td>
                    <td data-duice-object="user" data-duice-property="name"></td>
                    <td><span data-duice-object="user" data-duice-property="type"></span></td>
                    <td><span data-duice-object="user" data-duice-property="status"></span></td>
                    <td data-duice-object="user" data-duice-property="email"></td>
                    <td data-duice-object="user" data-duice-property="mobile"></td>
                    <td>
                    <span data-duice-object="user" data-duice-script="
                    let roleIds = [];
                    user.roles.forEach(role => {
                        roleIds.push(role.id);
                    });
                    this.appendChild(document.createTextNode(roleIds.join(',')));
                    "></span>
                    </td>
                    <td>
                        <button data-duice-object="user" data-duice-script="this.dataset.id=user.id;"
                                onclick="getUser(this.dataset.id);">
                            <img class="icon" th:src="@{/static/image/icon-detail.png}"/>
                            <span data-th-text="#{web.text.detail}"></span>
                        </button>
                    </td>
                </tr>
                <tr data-duice-array="users" data-duice-script="if(users.length === 0) this.hidden=false;" hidden>
                    <td colspan="100%" class="fs-smaller">No Data</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="container">
            <div class="col-4"></div>
            <div class="col-4 justify-center">
                <duice-pagination
                        data-duice-object="userSearch"
                        data-duice-size-property="_size"
                        data-duice-page-property="_page"
                        data-duice-count-property="_count"
                        data-duice-onclick="getUsers(this.dataset.page);">
                </duice-pagination>
            </div>
            <div class="col-4 justify-right">
                <span data-th-text="#{web.text.total}"></span>
                <span data-duice-object="userSearch" data-duice-property="_count" data-duice-format="number(0)"></span>
                <span data-th-text="#{web.text.rows}"></span>
            </div>
        </div>
    </div>

    <!-- roleTabContent -->
    <div id="roleTabContent">
        <div class="row">
            <div class="col">
                <form onsubmit="return false;">
                    <select data-duice-object="roleSearch" data-duice-property="key">
                        <option value="id" th:text="#{core.role.id}"></option>
                        <option value="name" th:text="#{core.role.name}"></option>
                    </select>
                    <input type="text" data-duice-object="roleSearch" data-duice-property="value" th:placeholder="#{web.text.keyword}"/>
                    <button onclick="getRoles();">
                        <img class="icon" th:src="@{/static/image/icon-search.png}"/>
                        <span data-th-text="#{web.text.search}">Search</span>
                    </button>
                    <button onclick="resetRoleSearch();">
                        <img class="icon" th:src="@{/static/image/icon-reset.png}"/>
                        <span data-th-text="#{web.text.reset}">Reset</span>
                    </button>
                </form>
            </div>
            <div class="col">
                <button onclick="createRole();">
                    <img class="icon" th:src="@{/static/image/icon-create.png}"/>
                    <span data-th-text="#{web.text.create}"></span>
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <table>
                    <colgroup>
                        <col style="width:80px;"/>
                        <col/>
                        <col/>
                        <col/>
                        <col style="width:70px;"/>
                    </colgroup>
                    <thead>
                    <tr>
                        <th data-th-text="#{web.text.no}" class="ta-center"></th>
                        <th data-th-text="#{core.role.id}"></th>
                        <th data-th-text="#{core.role.name}"></th>
                        <th data-th-text="#{core.role.authorities}"></th>
                        <th class="ta-center">-</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr data-duice-array="roles" data-duice-loop="role,status">
                        <td data-duice-object="status" data-duice-property="count" class="ta-center"></td>
                        <td>
                            <img data-duice-object="role" data-duice-property="icon"
                                 th:src="@{/static/image/icon-null.png}" class="icon"/>
                            <span data-duice-object="role" data-duice-property="id" class="fw-bold"></span>
                        </td>
                        <td data-duice-object="role" data-duice-property="name"></td>
                        <td>
                    <span data-duice-object="role" data-duice-script="
                    let authorityIds = [];
                    console.log(role.authorities);
                    role.authorities.forEach(authority => {
                        authorityIds.push(authority.id);
                    });
                    this.appendChild(document.createTextNode(authorityIds.join(',')));
                    "></span>
                        </td>
                        <td class="ta-center">
                            <button data-duice-object="role" data-duice-script="this.dataset.id=role.id;"
                                    onclick="getRole(this.dataset.id);">
                                <img class="icon" th:src="@{/static/image/icon-detail.png}"/>
                                <span data-th-text="#{web.text.detail}">Detail</span>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col"></div>
            <div class="col">
                <duice-pagination
                        data-duice-object="roleSearch"
                        data-duice-size-property="_size"
                        data-duice-page-property="_page"
                        data-duice-count-property="_count"
                        data-duice-onclick="getRoles(this.dataset.page);">
                </duice-pagination>
            </div>
            <div class="col">
                <span data-th-text="#{web.text.total}"></span>
                <span data-duice-object="roleSearch" data-duice-property="_count" data-duice-format="number(0)"></span>
                <span data-th-text="#{web.text.rows}"></span>
            </div>
        </div>
    </div>

    <!-- authorityTabContent -->
    <div id="authorityTabContent">
        <div class="row">
            <div class="col">
                <form onsubmit="return false;">
                    <select data-duice-object="authoritySearch" data-duice-property="key">
                        <option value="id" th:text="#{core.authority.id}"></option>
                        <option value="name" th:text="#{core.authority.name}"></option>
                    </select>
                    <input type="text" data-duice-object="authoritySearch" data-duice-property="value" th:placeholder="#{web.text.keyword}"/>
                    <button onclick="getAuthorities();">
                        <img class="icon" th:src="@{/static/image/icon-search.png}"/>
                        <span data-th-text="#{web.text.search}">Search</span>
                    </button>
                    <button onclick="resetAuthoritiesSearch();">
                        <img class="icon" th:src="@{/static/image/icon-reset.png}"/>
                        <span data-th-text="#{web.text.reset}">Reset</span>
                    </button>
                </form>
            </div>
            <div class="col">
                <button onclick="createAuthority();">
                    <img class="icon" th:src="@{/static/image/icon-create.png}"/>
                    <span data-th-text="#{web.text.create}"></span>
                </button>
            </div>
        </div>
        <table>
            <colgroup>
                <col style="width:80px;"/>
                <col/>
                <col/>
                <col style="width:70px;"/>
            </colgroup>
            <thead>
            <tr>
                <th data-th-text="#{web.text.no}" class="ta-center"></th>
                <th data-th-text="#{core.authority.id}"></th>
                <th data-th-text="#{core.authority.name}"></th>
                <th class="ta-center">-</th>
            </tr>
            </thead>
            <tbody>
            <tr data-duice-array="authorities" data-duice-loop="authority,status">
                <td data-duice-object="status" data-duice-property="count" class="ta-center"></td>
                <td>
                    <img data-duice-object="authority" data-duice-property="icon" th:src="@{/static/image/icon-null.png}" class="icon"/>
                    <span data-duice-object="authority" data-duice-property="id" class="fw-bold"></span>
                </td>
                <td data-duice-object="authority" data-duice-property="name"></td>
                <td class="ta-center">
                    <button data-duice-object="authority" data-duice-script="this.dataset.id=authority.id;" onclick="getAuthority(this.dataset.id);">
                        <img class="icon" th:src="@{/static/image/icon-detail.png}"/>
                        <span data-th-text="#{web.text.detail}">Detail</span>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
        <div class="row">
            <div class="col"></div>
            <div class="col">
                <duice-pagination
                        data-duice-object="authoritySearch"
                        data-duice-size-property="_size"
                        data-duice-page-property="_page"
                        data-duice-count-property="_count"
                        data-duice-onclick="getAuthorities(this.dataset.page);">
                </duice-pagination>
            </div>
            <div class="col">
                <span data-th-text="#{web.text.total}"></span>
                <span data-duice-object="authoritySearch" data-duice-property="_count" data-duice-format="number(0)"></span>
                <span data-th-text="#{web.text.rows}"></span>
            </div>
        </div>
    </div>

    <!-- userDetail -->
    <dialog id="userDetail">
        <style>
            #userDetail {
                width: 800px;
                padding: 1.5rem;
            }
        </style>
        <script>
        const userDetail = {
            dialog: new duice.dialog.Dialog(document.getElementById('userDetail')),
            isNew: false,
            user: new duice.ObjectProxy({
                roles: []
            }),
            open: function(id) {
                duice.ObjectProxy.clear(this.user);
                if(id) {
                    this.isNew = false;
                    let url = new URL('[[@{/admin/user/get-user}]]', document.location.origin);
                    url.searchParams.append('id', id);
                    _fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            duice.ObjectProxy.assign(this.user, data);
                            duice.ObjectProxy.setReadonly(this.user, 'id', true);
                        });
                }else{
                    this.isNew = true;
                    duice.ObjectProxy.assign(this.user, {
                        type: 'GENERAL',
                        status: 'ACTIVE'
                    });
                    duice.ObjectProxy.setReadonlyAll(this.user, false);
                }

                // readonly
                duice.ObjectProxy.setReadonly(this.user, 'joinDateTime', true);
                duice.ObjectProxy.setReadonly(this.user, 'loginDateTime', true);

                // property change listener
                let _this = this;
                duice.ObjectProxy.onPropertyChanging(this.user, async function(event) {
                    if(event.getProperty() === 'id'){
                        if(!await _this.validateId(event.getValue())) {
                            return false;
                        }
                    }
                    return true;
                });

                // password division
                document.getElementById('userDetail_passwordDiv').style.display = (this.isNew ? '' : 'none');

                // open dialog
                return this.dialog.open();
            },
            /**
             * addRole
             * @returns {Promise<void>}
             */
            addRole: async function() {
                let alreadySelectedRoleIds = [];
                this.user.roles.forEach(role=>{
                    alreadySelectedRoleIds.push(role.id);
                });
                let selectedRoles = await roleSelect.open(alreadySelectedRoleIds);
                selectedRoles.forEach(role => {
                    this.user.roles.push(role);
                });
            },
            /**
             * removeRole
             * @param index
             */
            removeRole: function(index) {
                this.user.roles.splice(index,1);
            },
            /**
             * validateId
             * @param id
             * @returns {Promise<boolean>}
             */
            validateId: async function(id) {

                // check blank
                if(!id) {
                    await duice.alert('[[#{web.message.itemEmpty(#{core.user.id})}]]');
                    duice.ObjectProxy.focus(this.user, 'id');
                    return false;
                }

                // check duplicated id
                let url = new URL('[[@{/admin/user/get-user}]]', document.location.origin);
                url.searchParams.append('id', id);
                let response = await _fetch(url,{},true);
                if(response.ok) {
                    let user = await response.json();
                    if(user) {
                        await _alert('[[#{web.message.itemAlreadyExist(#{core.user.id})}]]');
                        return false;
                    }
                }

                // return true
                return true;
            },
            save: async function() {

                // if new, checks id
                if(this.isNew) {
                    if(! await this.validateId(this.user.id)){
                        return false;
                    }
                }

                // checks name
                if(!this.user.name || this.user.name.trim().length < 1) {
                    await _alert('[[#{web.message.itemEmpty(#{core.user.name})}]]');
                    duice.ObjectProxy.focus(this.user, 'name');
                    return false;
                }

                // checks password
                if(this.isNew) {
                    if(!this.user.password || this.user.password.trim().length < 1) {
                        await _alert('[[#{web.message.itemEmpty(#{core.user.password})}]]');
                        duice.ObjectProxy.focus(this.user, 'password');
                        return false;
                    }
                    if(!this.user.passwordConfirm || this.user.passwordConfirm.trim().length < 1) {
                        await _alert('[[#{web.message.itemEmpty(#{core.user.password})}]]');
                        duice.ObjectProxy.focus(this.user, 'passwordConfirm');
                        return false;
                    }
                    if(this.user.password !== this.user.passwordConfirm) {
                        await _alert('[[#{web.message.itemNotMatch(#{core.user.password})}]]');
                        duice.ObjectProxy.focus(this.user, 'password');
                        return false;
                    }
                }

                // call save
                duice.confirm('[[#{web.message.saveItemConfirm(#{core.user})}]]').then(result => {
                    if(result) {
                        let url = new URL('[[@{/admin/user/save-user}]]', document.location.origin);
                        _fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type' : 'application/json'
                            },
                            body: JSON.stringify(this.user)
                        }).then(response => {
                            if(response.ok) {
                                _alert('[[#{web.message.saveItemComplete(#{core.user})}]]').then(() => {
                                    this.dialog.resolve(true);
                                });
                            }
                        });
                    }
                });
            },
            delete: function() {
                duice.confirm('[[#{web.message.deleteItemConfirm(#{core.user})}]]').then(result => {
                    if(result) {
                        let url = new URL('[[@{/admin/user/delete-user}]]', document.location.origin);
                        url.searchParams.append('id', this.user.id);
                        _fetch(url).then(response => {
                            if(response.ok) {
                                _alert('[[#{web.message.deleteItemComplete(#{core.user})}]]').then(() => {
                                    this.dialog.resolve(true);
                                });
                            }
                        })
                    }
                });
            }
        }
        </script>
        <h1>
            <img class="icon" th:src="@{/static/image/icon-user.png}"/>
            <span data-th-text="#{core.user}"></span>
        </h1>
        <div class="container gap-1px gap-column-1rem">
            <div class="col-2">
                <span data-th-text="#{core.user.id}" class="fw-bold tag-required"></span>
            </div>
            <div class="col-4">
                <input type="text" data-duice-object="userDetail.user" data-duice-property="id" class="w-100 fw-bold"/>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.name}" class="fw-bold tag-required"></span>
            </div>
            <div class="col-4">
                <input type="text" data-duice-object="userDetail.user" data-duice-property="name" class="w-100"/>
            </div>
            <div id="userDetail_passwordDiv" class="col-12 container gap-1px gap-column-1rem">
                <div class="col-2">
                    <span data-th-text="#{core.user.password}" class="fw-bold tag-required"></span>
                </div>
                <div class="col-4">
                    <input type="password" data-duice-object="userDetail.user" data-duice-property="password" class="w-100"/>
                </div>
                <div class="col-2">
                    <span data-th-text="#{core.user.password}" class="fw-bold tag-required"></span>
                </div>
                <div class="col-4">
                    <input type="password" data-duice-object="userDetail.user" data-duice-property="passwordConfirm" class="w-100"/>
                </div>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.type}" class="fw-bold"></span><br>
            </div>
            <div class="col-4">
                <select data-duice-object="userDetail.user" data-duice-property="type" class="w-100">
                    <option th:each="userType:${userTypes}" th:value="${userType}" th:text="${userType}"></option>
                </select>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.status}" class="fw-bold"></span><br>
            </div>
            <div class="col-4">
                <select data-duice-object="userDetail.user" data-duice-property="status" class="w-100">
                    <option th:each="userStatus:${userStatuses}" th:value="${userStatus}" th:text="${userStatus}"></option>
                </select>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.email}" class="fw-bold"></span><br>
            </div>
            <div class="col-4">
                <input type="email" data-duice-object="userDetail.user" data-duice-property="email" class="w-100"/>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.mobile}" class="fw-bold"></span><br>
            </div>
            <div class="col-4">
                <input type="tel" data-duice-object="userDetail.user" data-duice-property="mobile" class="w-100"/>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.joinDatetime}" class="fw-bold"></span>
            </div>
            <div class="col-4">
                <input type="datetime-local" data-duice-object="userDetail.user" data-duice-property="joinDateTime" class="w-100"/>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.loginDatetime}" class="fw-bold"></span>
            </div>
            <div class="col-4">
                <input type="datetime-local" data-duice-object="userDetail.user" data-duice-property="loginDateTime" class="w-100"/>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.photo}" class="fw-bold"></span><br>
            </div>
            <div class="col-4">
                <img th:src="@{/static/image/icon-null.png}" data-duice-object="userDetail.user" data-duice-property="photo" data-duice-editable="true" data-duice-size="64,64" style="width:64px; height:64px;"/>
            </div>
            <div class="col-6"></div>
            <div class="col-2">
                <span data-th-text="#{core.user.profile}" class="fw-bold"></span>
            </div>
            <div class="col-10">
                <textarea data-duice-object="userDetail.user" data-duice-property="profile" rows="4" class="w-100 h-100"></textarea>
            </div>
            <div class="col-2">
                <span data-th-text="#{core.user.roles}" class="fw-bold"></span>
            </div>
            <div class="col-10">
                <div class="overflow-y-scroll border-1" style="max-height:calc(10rem - 2px);">
                    <table class="w-100 border-0">
                        <colgroup>
                            <col style="width:70px;"/>
                            <col/>
                            <col/>
                            <col style="width:35px;"/>
                        </colgroup>
                        <thead>
                        <tr>
                            <th data-th-text="#{web.text.no}" class="ta-center"></th>
                            <th data-th-text="#{core.role.id}"></th>
                            <th data-th-text="#{core.role.name}"></th>
                            <th class="ta-center">
                                <button onclick="userDetail.addRole();">
                                    <img class="icon" th:src="@{/static/image/icon-add.png}"/>
                                </button>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr data-duice-array="userDetail.user.roles" data-duice-loop="role,status">
                            <td data-duice-object="status" data-duice-property="count" class="ta-center"></td>
                            <td>
                                <img data-duice-object="role" data-duice-property="icon"
                                     th:src="@{/static/image/icon-null.png}"
                                     class="icon"/>
                                <span data-duice-object="role" data-duice-property="id" class="fw-bold"></span>
                            </td>
                            <td data-duice-object="role" data-duice-property="name"></td>
                            <td class="ta-center">
                                <button data-duice-object="role" data-duice-script="this.dataset.index=status.index;"
                                        onclick="userDetail.removeRole(this.dataset.index);">
                                    <img class="icon" th:src="@{/static/image/icon-remove.png}"/>
                                </button>
                            </td>
                        </tr>
                        <tr data-duice-array="userDetail.user.roles"
                            data-duice-script="if(userDetail.user.roles.length === 0) this.hidden=false;" hidden>
                            <td colspan="100%" class="ta-center fs-smaller">No Data</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="container margin-1px">
            <div class="col-12 justify-right">
                <button>
                    <img class="icon" th:src="@{/static/image/icon-password.png}"/>
                    <span data-th-text="#{web.text.changePassword}"></span>
                </button>
                <button>
                    <img class="icon" th:src="@{/static/image/icon-token.png}"/>
                    <span data-th-text="#{web.text.authorizationToken}"></span>
                </button>
                <button onclick="userDetail.delete();">
                    <img class="icon" th:src="@{/static/image/icon-delete.png}"/>
                    <span data-th-text="#{web.text.delete}"></span>
                </button>
                <button onclick="userDetail.save();">
                    <img class="icon" th:src="@{/static/image/icon-save.png}"/>
                    <span data-th-text="#{web.text.save}"></span>
                </button>
            </div>
        </div>
    </dialog>

    <!-- roleSelect -->
    <dialog id="roleSelect">
        <style>
            #roleSelect {
                width: 700px;
                padding: 1.5rem;
            }
        </style>
        <script>
            const roleSelect = {
                dialog: new duice.dialog.Dialog(document.getElementById('roleSelect')),
                alreadySelectedRoleIds : null,
                roleSearch: new duice.ObjectProxy({
                    key: 'id',
                    value: null,
                    _page: 0,
                    _size: 5,
                    _count: 0
                }),
                roles: new duice.ArrayProxy([]),
                selectedRoles: new duice.ArrayProxy([]),
                /**
                 * open
                 * @param alreadySelectedRoleIds
                 */
                open: async function(alreadySelectedRoleIds) {
                    if(alreadySelectedRoleIds) {
                        this.alreadySelectedRoleIds = alreadySelectedRoleIds;
                    }else{
                        this.alreadySelectedRoleIds = [];
                    }
                    duice.ArrayProxy.clear(this.selectedRoles);
                    this.getRoles(0);
                    return this.dialog.open();
                },
                /**
                 * getRoles
                 * @param page
                 */
                getRoles: function(page) {
                    if(page) {
                        this.roleSearch._page = page;
                    }
                    let url = new URL('[[@{/admin/user/get-roles}]]',document.location.origin);
                    if(this.roleSearch.key && this.roleSearch.value) {
                        url.searchParams.append(this.roleSearch.key, this.roleSearch.value);
                    }
                    url.searchParams.append('_page', this.roleSearch._page);
                    url.searchParams.append('_size', this.roleSearch._size);
                    _fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        duice.ArrayProxy.clear(this.roles);
                        duice.ArrayProxy.assign(this.roles, data.content);
                        this.roleSearch._count = data.totalElements;
                        // check already selected
                        this.roles.forEach(role => {
                            if(this.alreadySelectedRoleIds.includes(role.id)){
                                role['_selected'] = true;
                            }
                            this.selectedRoles.forEach(element => {
                                if(element.id === role.id) {
                                    role['_selected'] = true;
                                }
                            });
                        });
                    });
                },
                /**
                 * resetRoles
                 */
                resetRoles: function() {
                    duice.ObjectProxy.reset(this.roleSearch);
                    this.getRoles();
                },
                /**
                 * select role
                 * @param index
                 */
                selectRole: function(index) {
                    console.log('== index', index);
                    let role = JSON.parse(JSON.stringify(this.roles[index]));
                    this.selectedRoles.push(role);
                    this.roles.forEach(element => {
                        if(element.id === role.id) {
                            element['_selected'] = true;
                            return false;
                        }
                    });
                },
                /**
                 * deselect role
                 * @param index
                 */
                deselectRole: async function(index) {
                    let role = this.selectedRoles[index];
                    this.selectedRoles.splice(index, 1);
                    this.roles.forEach(element => {
                        if(element.id === role.id) {
                            element['_selected'] = false;
                            return false;
                        }
                    });
                },
                /**
                 * confirm
                 */
                confirm: function() {
                    this.dialog.resolve(this.selectedRoles);
                }
            }
        </script>
        <h1>
            <img class="icon" th:src="@{/static/image/icon-role.png}"/>
            <span data-th-text="#{core.role}"></span>
        </h1>
        <div class="container gap-1px margin-1px">
            <form onsubmit="return false;" class="col-12 container gap-1px">
                <select data-duice-object="roleSelect.roleSearch" data-duice-property="key" class="col-1">
                    <option value="id" th:text="#{core.role.id}"></option>
                    <option value="name" th:text="#{core.role.name}"></option>
                </select>
                <input type="text" data-duice-object="roleSelect.roleSearch" data-duice-property="value" class="col-2"/>
                <button onclick="roleSelect.getRoles();" class="col-1">
                    <img class="icon" th:src="@{/static/image/icon-search.png}"/>
                    <span data-th-text="#{web.text.search}">Search</span>
                </button>
                <button onclick="roleSelect.resetRoles();" class="col-1">
                    <img class="icon" th:src="@{/static/image/icon-reset.png}"/>
                    <span data-th-text="#{web.text.reset}">Reset</span>
                </button>
            </form>
        </div>
        <div class="overflow-x-scroll border-1">
            <table class="border-0">
                <colgroup>
                    <col style="width:70px;"/>
                    <col style="width:30%;"/>
                    <col/>
                    <col style="width:35px;"/>
                </colgroup>
                <thead>
                <tr>
                    <th data-th-text="#{web.text.no}" class="ta-center"></th>
                    <th data-th-text="#{core.role.id}"></th>
                    <th data-th-text="#{core.role.name}"></th>
                    <th class="ta-center">-</th>
                </tr>
                </thead>
                <tbody>
                <tr data-duice-array="roleSelect.roles" data-duice-loop="role,status">
                    <td data-duice-object="status" data-duice-property="count" class="ta-center"></td>
                    <td>
                        <img data-duice-object="role" data-duice-property="icon" th:src="@{/static/image/icon-null.png}"
                             class="icon"/>
                        <span data-duice-object="role" data-duice-property="id" class="fw-bold"></span>
                    </td>
                    <td data-duice-object="role" data-duice-property="name"></td>
                    <td class="ta-center">
                        <button data-duice-object="role"
                                data-duice-script="
                            this.dataset.index = status.index;
                            if(role._selected) {
                                this.disabled = true;
                            }"
                                onclick="roleSelect.selectRole(this.dataset.index);">
                            <img class="icon" th:src="@{/static/image/icon-add.png}"/>
                        </button>
                    </td>
                </tr>
                <tr data-duice-array="roleSelect.roles"
                    data-duice-script="if(roleSelect.roles.length === 0) this.hidden=false;" hidden>
                    <td colspan="100%" class="ta-center fs-smaller">No Data</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="container">
            <div class="col-4"></div>
            <div class="col-4 justify-center">
                <duice-pagination
                    data-duice-object="roleSelect.roleSearch"
                    data-duice-size-property="_size"
                    data-duice-page-property="_page"
                    data-duice-count-property="_count"
                    data-duice-onclick="roleSelect.getRoles(this.dataset.page);">
                </duice-pagination>
            </div>
            <div class="col-4 justify-right">
                <span data-th-text="#{web.text.total}"></span>
                <span data-duice-object="roleSelect.roleSearch" data-duice-property="_count" data-duice-format="number(0)"></span>
                <span data-th-text="#{web.text.rows}"></span>
            </div>
        </div>
        <div class="border-1 overflow-x-scroll">
            <table class="border-0">
                <colgroup>
                    <col style="width:70px;"/>
                    <col style="width:30%;"/>
                    <col/>
                    <col style="width:35px;"/>
                </colgroup>
                <thead>
                <tr>
                    <th data-th-text="#{web.text.no}" class="ta-center"></th>
                    <th data-th-text="#{core.role.id}"></th>
                    <th data-th-text="#{core.role.name}"></th>
                    <th class="ta-center">-</th>
                </tr>
                </thead>
                <tbody>
                <tr data-duice-array="roleSelect.selectedRoles" data-duice-loop="role,status">
                    <td data-duice-object="status" data-duice-property="count" class="ta-center"></td>
                    <td>
                        <img data-duice-object="role" data-duice-property="icon" th:src="@{/static/image/icon-null.png}"
                             class="icon"/>
                        <span data-duice-object="role" data-duice-property="id" class="fw-bold"></span>
                    </td>
                    <td data-duice-object="role" data-duice-property="name"></td>
                    <td class="ta-center">
                        <button data-duice-object="role"
                                data-duice-script="this.dataset.index = status.index;"
                                onclick="roleSelect.deselectRole(this.dataset.index);">
                            <img class="icon" th:src="@{/static/image/icon-remove.png}"/>
                        </button>
                    </td>
                </tr>
                <tr data-duice-array="roleSelect.selectedRoles"
                    data-duice-script="if(roleSelect.selectedRoles.length === 0) this.hidden=false;" hidden>
                    <td colspan="100%" class="ta-center fs-smaller">No Data</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="container padding-1px">
            <div class="col-12 justify-right">
                <button onclick="roleSelect.confirm();">
                    <img class="icon" th:src="@{/static/image/icon-confirm.png}"/>
                    <span data-th-text="#{web.text.confirm}"></span>
                </button>
            </div>
        </div>
    </dialog>

</main>